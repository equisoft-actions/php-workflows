name: PHP Security

on:
  workflow_call:
    inputs:
      report-retention-days:
        description: "Duration in days to preserve reports."
        required: false
        default: "5"
        type: string
      working-directory:
        description: "Workflow working directory"
        default: '.'
        required: false
        type: string
      php-version:
        description: 'Setup PHP version.'
        default: '7.4'
        required: false
        type: string
      extensions:
        description: 'Setup PHP extensions.'
        required: false
        type: string
      publish-reports:
        description: "Publish SARIF and SBOM reports to Defect Dojo and Dependency Track respectively."
        default: false
        required: false
        type: boolean
      defectdojo-engagement:
        description: "DefectDojo Engagement name or id"
        default: ''
        required: false
        type: string
      dependency-track-project-name:
        description: Project name for Dependency Track.
        required: false
        type: string
      dependency-track-project-version:
        description: Project name for Dependency Track. Typically the default branch unless multiple forks are maintained.
        default: main
        required: false
        type: string
    secrets:
      GPR_KEY:
        description: Personal access token to fetch private repos
        required: false
      DEFECTDOJO_URL:
        description: DefectDojo URL
        required: false
      DEFECTDOJO_TOKEN:
        description: DefectDojo API Token
        required: false
      DEPENDENCY_TRACK_URL:
        description: URL to the Dependency Track instance to publish the SBOM to.
        required: false
      DEPENDENCY_TRACK_API_KEY:
        description: API key of the Dependency Track instance.
        required: false

env:
  php-cache-key: v1

jobs:
  psalm-taint-analysis:
    name: psalm taint analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: equisoft-actions/setup-php@v1.2.0
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.extensions }}
          cache-key: ${{ env.php-cache-key }}

      - name: Composer install
        uses: equisoft-actions/composer@v1.2.0
        with:
          gpr-key: ${{ secrets.GPR_KEY}}
          working-directory: ${{ inputs.working-directory }}

      - name: Taint analysis
        uses: equisoft-actions/psalm-taint-analysis@v1.2.0
        with:
          working-directory: ${{ inputs.working-directory }}
          report-retention-days: ${{ inputs.report-retention-days }}
          defectdojo-publish: ${{ inputs.publish-reports }}
          defectdojo-url: ${{ secrets.DEFECTDOJO_URL }}
          defectdojo-engagement: ${{ inputs.defectdojo-engagement }}
          defectdojo-token: ${{ secrets.DEFECTDOJO_TOKEN }}

  sbom:
    name: Generate SBOM
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v3

      - name: Setup PHP
        uses: equisoft-actions/setup-php@v1.2.0
        with:
          php-version: ${{ inputs.php-version }}
          extensions: ${{ inputs.extensions }}
          cache-key: ${{ env.php-cache-key }}

      - name: Composer install
        uses: equisoft-actions/composer@v1.2.0
        with:
          gpr-key: ${{ secrets.GPR_KEY }}
          working-directory: ${{ inputs.working-directory }}

      - name: Generate SBOM
        uses: equisoft-actions/composer-sbom@v1.0.0
        with:
          dependency-track-api-key: ${{ secrets.DEPENDENCY_TRACK_API_KEY }}
          dependency-track-url: ${{ secrets.DEPENDENCY_TRACK_URL }}
          dependency-track-project-name: ${{ inputs.dependency-track-project-name }}
          dependency-track-project-version: ${{ inputs.dependency-track-project-version }}
          publish: ${{ inputs.publish-reports }}
          report-retention-days: ${{ inputs.report-retention-days }}
          working-directory: ${{ inputs.working-directory }}
